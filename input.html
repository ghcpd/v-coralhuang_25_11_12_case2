<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chat UI Broken Enhanced</title>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  overflow-y: scroll;
  background-color: #f3f3f3;
}
.chat-container {
  width: 100%;
  max-width: 600px;
  margin: 0 auto;
  background: white;
  height: 90vh;
  overflow-y: auto;
  position: relative;
}

/* BUG #1: absolute positioning creates overlap and drifting avatars */
.message {
  position: absolute;
  display: flex;
  align-items: flex-end;
  padding: 10px 15px;
  border-radius: 16px;
  max-width: 70%;
  margin: 8px;
  color: #fff;
  transition: all 0.2s;
}
.message.left {
  left: 10px;
  background: #4a90e2;
}
.message.right {
  right: 10px;
  background: #7b7b7b;
}

/* avatar not fixed to bubble due to absolute layout */
.avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  margin-right: 8px;
}

/* BUG #2: random size and wrong rotation simulates EXIF & ratio error */
.message img.media {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transform: rotate(90deg);
  border-radius: 10px;
}

/* BUG #3: header jumps when new inserted, fixed positioning amplifies flicker */
.time-header {
  position: sticky;
  top: 0;
  text-align: center;
  font-size: 12px;
  color: #999;
  padding: 5px;
  background: #eee;
  z-index: 10;
  animation: flicker 0.3s ease-in-out;
}
@keyframes flicker {
  0% { opacity: 0; transform: translateY(-10px);}
  100% { opacity: 1; transform: translateY(0);}
}

button {
  position: fixed;
  bottom: 15px;
  right: 15px;
  background: #4a90e2;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 12px;
  cursor: pointer;
}
</style>
</head>
<body>

<div class="chat-container" id="chat">
  <div class="time-header">09:00 AM</div>
  <div class="message left">
    <img class="avatar" src="https://i.pravatar.cc/40?img=1">
    <div>Hey! How are you doing today?</div>
  </div>
  <div class="message right">
    <img class="avatar" src="https://i.pravatar.cc/40?img=2">
    <div>I'm good! Working on that new UI layout.</div>
  </div>
  <div class="message left">
    <img class="avatar" src="https://i.pravatar.cc/40?img=3">
    <img class="media" src="https://picsum.photos/200/600" alt="img">
  </div>
  <div class="message right">
    <img class="avatar" src="https://i.pravatar.cc/40?img=4">
    <div>Cool, send me screenshots later.</div>
  </div>
</div>

<button id="simulate">Simulate Scroll & Update</button>

<script>
const chat = document.getElementById('chat');
const btn = document.getElementById('simulate');

btn.onclick = () => {
  // use requestAnimationFrame for continuous fast scroll simulation
  let scrollCount = 0;
  function fastScroll() {
    chat.scrollTop = (scrollCount % 2 === 0) ? chat.scrollHeight : 0;
    scrollCount++;
    if (scrollCount < 20) {
      requestAnimationFrame(fastScroll);
    } else {
      injectNewContent();
    }
  }
  fastScroll();
};

// BUG: injecting without cleanup â†’ drifting avatars, duplicated IDs, unstable DOM
function injectNewContent() {
  const header = document.createElement('div');
  header.className = 'time-header';
  header.innerText = '09:' + (Math.floor(Math.random() * 60)).toString().padStart(2, '0') + ' AM';
  chat.insertBefore(header, chat.firstChild);

  const msg = document.createElement('div');
  msg.className = (Math.random() > 0.5) ? 'message left' : 'message right';

  // random avatar & random image size to simulate inconsistent media
  const avatar = document.createElement('img');
  avatar.className = 'avatar';
  avatar.src = 'https://i.pravatar.cc/40?img=' + Math.floor(Math.random() * 10 + 1);

  msg.appendChild(avatar);

  if (Math.random() > 0.5) {
    const img = document.createElement('img');
    img.className = 'media';
    const w = Math.floor(Math.random() * 200 + 150);
    const h = Math.floor(Math.random() * 400 + 200);
    img.src = `https://picsum.photos/${w}/${h}`;
    msg.appendChild(img);
  } else {
    msg.appendChild(document.createTextNode('Random text message ' + Math.floor(Math.random() * 100)));
  }

  chat.appendChild(msg);

  // Force layout reflow and scroll jump
  chat.innerHTML += '';
}
</script>

</body>
</html>
